{
  "name": "BT Broadband Availability Checker - Template",
  "description": "Parameterized workflow template for checking broadband availability. Use {{username}}, {{postcode}}, {{building_number}}, {{street}}, and {{full_address}} variables.",
  "starting_page": "https://bbactotl.btwholesale.com/bbac-ui/totl/totlSearch/#/ADSL/AddressHome",
  "llm_provider": "openai",
  "llm_model": "gpt-4o-mini",
  "abort_on_error": false,
  "default_delay": 300,
  "screenshot_config": {
    "s3_prefix": "verification",
    "upload_mode": "marked_only"
  },
  "session": {
    "profile_name": "Bt_broadband",
    "required_tags": ["bt.com", "authenticated"],
    "allow_temp_profile": false,
    "clone_for_parallel": false
  },
  "steps": [
    {
      "action": "wait_for_load_state",
      "description": "Wait for initial page load",
      "state": "networkidle"
    },
    {
      "type": "if",
      "name": "CheckAuthenticationStatus",
      "description": "Detect if login required or already authenticated",
      "condition": {
        "type": "or",
        "conditions": [
          {
            "type": "element_visible",
            "selector": "input[type='password'], input[type='text'][name*='user']",
            "timeout": 3000
          },
          {
            "type": "js_eval",
            "expression": "document.title.toLowerCase().includes('secure authentication') || document.title.toLowerCase().includes('login')"
          }
        ]
      },
      "then": {
        "goto": "PerformLogin"
      },
      "else": {
        "goto": "PerformSearch"
      }
    },
    {
      "type": "sequence",
      "name": "PerformLogin",
      "description": "Complete login flow with password manager support",
      "steps": [
        {
          "type": "try",
          "name": "FillUsername",
          "strategies": [
            {
              "name": "Strategy 1: By name attribute",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[type='text'][name*='user'], input[type='email']"
                  },
                  "value": "{{username}}"
                }
              ]
            },
            {
              "name": "Strategy 2: First text input",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[type='text']:first-of-type"
                  },
                  "value": "{{username}}"
                }
              ]
            }
          ]
        },
        {
          "type": "try",
          "name": "ClickNextAfterUsername",
          "strategies": [
            {
              "name": "Strategy 1: Submit button",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "button[type='submit']"
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Next button",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "Next"
                  }
                }
              ]
            }
          ]
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "type": "if",
          "name": "CheckPasswordPage",
          "description": "Wait for password page to load (SPA may take time to render)",
          "condition": {
            "type": "element_visible",
            "selector": "input[type='password']",
            "timeout": 60000
          },
          "then": {
            "type": "sequence",
            "steps": [
              {
                "action": "wait",
                "description": "Wait for password manager autofill",
                "duration": 4000
              },
              {
                "type": "if",
                "name": "CheckPasswordAutofilled",
                "condition": {
                  "type": "js_eval",
                  "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                },
                "then": {
                  "continue": true
                },
                "else": {
                  "type": "try",
                  "name": "FillPasswordWithPasswordManager",
                  "strategies": [
                    {
                      "name": "Strategy 1: Tab + Enter",
                      "steps": [
                        {
                          "action": "click",
                          "locator": {
                            "strategy": "selector",
                            "value": "input[type='password']"
                          },
                          "trigger_autofill": true
                        },
                        {
                          "action": "wait",
                          "duration": 1500
                        },
                        {
                          "action": "press",
                          "key": "Tab",
                          "delay": 300
                        },
                        {
                          "action": "press",
                          "key": "Enter",
                          "delay": 300
                        },
                        {
                          "action": "wait",
                          "duration": 1000
                        }
                      ],
                      "verify": {
                        "type": "js_eval",
                        "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                      }
                    },
                    {
                      "name": "Strategy 2: Vision LLM",
                      "escalate": {
                        "type": "vision_llm",
                        "prompt": "A password manager dropdown has appeared. Click on the first saved password entry in the dropdown to select it and fill the password.",
                        "timeout": 25000,
                        "max_actions": 5
                      },
                      "verify": {
                        "type": "js_eval",
                        "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                      }
                    },
                    {
                      "name": "Strategy 3: Manual",
                      "steps": [
                        {
                          "action": "click",
                          "locator": {
                            "strategy": "selector",
                            "value": "input[type='password']"
                          },
                          "trigger_autofill": true
                        },
                        {
                          "action": "wait",
                          "description": "Wait for manual password selection",
                          "duration": 30000
                        }
                      ],
                      "verify": {
                        "type": "js_eval",
                        "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                      }
                    }
                  ]
                }
              },
              {
                "action": "wait",
                "description": "Brief pause before clicking submit",
                "duration": 1000
              },
              {
                "type": "try",
                "name": "ClickNextAfterPassword",
                "strategies": [
                  {
                    "name": "Strategy 1: Next button by ID",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "selector",
                          "value": "button#next"
                        }
                      }
                    ]
                  },
                  {
                    "name": "Strategy 2: Submit button",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "selector",
                          "value": "button[type='submit']"
                        }
                      }
                    ]
                  },
                  {
                    "name": "Strategy 3: Sign In button by text",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "text",
                          "value": "Sign In"
                        }
                      }
                    ]
                  },
                  {
                    "name": "Strategy 4: Login button by text",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "text",
                          "value": "Login"
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        {
          "action": "wait_for_load_state",
          "description": "Wait for SSO redirect",
          "state": "networkidle"
        },
        {
          "action": "wait",
          "duration": 2000
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "type": "if",
          "name": "VerifyLoginSuccess",
          "condition": {
            "type": "js_eval",
            "expression": "!document.querySelector('input[type=\"password\"]') && (window.location.href.includes('btwholesale') || window.location.href.includes('bbactotl'))"
          },
          "then": {
            "continue": true
          },
          "else": {
            "action": "error",
            "message": "Login failed - still on authentication page"
          }
        }
      ],
      "next": "PerformSearch"
    },
    {
      "type": "sequence",
      "name": "PerformSearch",
      "description": "Search for broadband availability",
      "steps": [
        {
          "type": "if",
          "name": "CheckIfOnAddressHomePage",
          "description": "Check if we're on the correct AddressHome page, if not navigate there",
          "condition": {
            "type": "or",
            "conditions": [
              {
                "type": "element_visible",
                "selector": "input[name='PostCode'], input[name='postcode'], input[id*='postcode' i]",
                "timeout": 3000
              },
              {
                "type": "url_contains",
                "pattern": "AddressHome"
              }
            ]
          },
          "then": {
            "continue": true
          },
          "else": {
            "type": "sequence",
            "description": "Navigate to AddressHome page",
            "steps": [
              {
                "type": "try",
                "name": "NavigateToAddressHome",
                "description": "Try clicking tab first, then direct navigation",
                "strategies": [
                  {
                    "name": "Strategy 1: Click Address Checker link by ID",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "selector",
                          "value": "a#addressNav"
                        }
                      },
                      {
                        "action": "wait_for_load_state",
                        "state": "networkidle"
                      }
                    ]
                  },
                  {
                    "name": "Strategy 2: Direct navigation to AddressHome",
                    "steps": [
                      {
                        "action": "navigate",
                        "url": "https://bbactotl.btwholesale.com/bbac-ui/totl/totlSearch/#/ADSL/AddressHome"
                      },
                      {
                        "action": "wait_for_load_state",
                        "state": "networkidle"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        {
          "action": "wait",
          "description": "Wait for Angular app to stabilize",
          "duration": 1000
        },
        {
          "type": "if",
          "name": "VerifySearchPageLoaded",
          "condition": {
            "type": "element_visible",
            "selector": "input[name='PostCode'], input[name='postcode'], input[id*='postcode' i]",
            "timeout": 5000
          },
          "then": {
            "continue": true
          },
          "else": {
            "action": "error",
            "message": "Postcode field not found on search page after navigation attempts"
          }
        },
        {
          "type": "try",
          "name": "FillPostcode",
          "description": "Fill postcode field - uses smart form_field strategy for Angular Material forms",
          "strategies": [
            {
              "name": "Strategy 1: Smart form_field (handles Angular Material, MUI, etc.)",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "form_field",
                    "label": "PostCode",
                    "field_type": "input"
                  },
                  "value": "{{postcode}}"
                }
              ]
            },
            {
              "name": "Strategy 2: By ID #postCode",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "#postCode"
                  },
                  "value": "{{postcode}}"
                }
              ]
            },
            {
              "name": "Strategy 3: By name attribute",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[name='postCode']"
                  },
                  "value": "{{postcode}}"
                }
              ]
            }
          ]
        },
        {
          "action": "wait",
          "description": "Random delay before search to avoid bot detection",
          "duration_range": [2000, 5000]
        },
        {
          "type": "try",
          "name": "ClickSearch",
          "description": "Click search button - includes retry for temporary 'checker is unavailable' errors",
          "strategies": [
            {
              "name": "Strategy 1: Submit button with retry",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "button[type='submit']"
                  },
                  "delay": 500,
                  "retry": {
                    "attempts": 5,
                    "delay_ms": 5000,
                    "retry_if": {
                      "text_visible": "checker is unavailable"
                    }
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Text search with retry",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "Search"
                  },
                  "delay": 500,
                  "retry": {
                    "attempts": 5,
                    "delay_ms": 5000,
                    "retry_if": {
                      "text_visible": "checker is unavailable"
                    }
                  }
                }
              ]
            }
          ]
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "action": "wait",
          "description": "Wait for search results or error message to appear",
          "duration": 2000
        },
        {
          "type": "if",
          "name": "CheckSearchServiceAvailable",
          "description": "Detect if BT checker returned 'unavailable' error after search submit",
          "condition": {
            "type": "element_visible",
            "selector": "text=checker is unavailable",
            "timeout": 1000
          },
          "then": {
            "action": "error",
            "message": "BT Checker service unavailable - the checker returned: 'We are sorry but the checker is unavailable at the moment. Please try again later.'"
          },
          "else": {
            "continue": true
          }
        }
      ],
      "next": "SelectAddress"
    },
    {
      "type": "sequence",
      "name": "SelectAddress",
      "description": "Select address from list if present",
      "steps": [
        {
          "type": "try",
          "name": "SelectAddressFromList",
          "description": "Progressive address matching: regex -> fuzzy -> vision with scroll",
          "strategies": [
            {
              "name": "Strategy 1: DOM extract + LLM text matching (select_option)",
              "steps": [
                {
                  "action": "select_by_llm",
                  "description": "Extract all options from address dropdown, send to LLM for text matching, use select_option() to properly trigger Angular change event",
                  "select_selector": "select.custom-select",
                  "target": "{{full_address}}",
                  "context_hint": "Building number: {{building_number}}, Street: {{street}}, Postcode: {{postcode}}"
                }
              ]
            },
            {
              "name": "Strategy 2: Wait and retry select_by_llm (page load fallback)",
              "steps": [
                {
                  "action": "wait",
                  "description": "Wait for page to fully load before retry",
                  "duration": 3000
                },
                {
                  "action": "select_by_llm",
                  "description": "Retry address selection after wait - page may not have loaded initially",
                  "select_selector": "select.custom-select",
                  "target": "{{full_address}}",
                  "context_hint": "Building number: {{building_number}}, Street: {{street}}, Postcode: {{postcode}}"
                }
              ]
            }
          ]
        },
        {
          "action": "execute_js",
          "description": "Force Angular change event on select element - required when Vision LLM fallback clicks option text instead of using select_option()",
          "script": "(() => { const sel = document.querySelector('select.custom-select'); if (sel && sel.selectedIndex > 0) { sel.dispatchEvent(new Event('change', { bubbles: true })); return 'change_event_dispatched_index_' + sel.selectedIndex; } return 'no_select_or_default'; })()"
        },
        {
          "action": "wait",
          "description": "Random delay before submit to avoid bot detection",
          "duration_range": [2000, 5000]
        },
        {
          "type": "try",
          "name": "ClickContinueAfterAddress",
          "description": "Click submit with retry for 'checker is unavailable' errors",
          "strategies": [
            {
              "name": "Strategy 1: Submit button with retry",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "button[type='submit']"
                  },
                  "delay": 300,
                  "retry": {
                    "attempts": 5,
                    "delay_ms": 5000,
                    "retry_if": {
                      "text_visible": "checker is unavailable"
                    }
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Continue button with retry",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "Continue"
                  },
                  "delay": 300,
                  "retry": {
                    "attempts": 5,
                    "delay_ms": 5000,
                    "retry_if": {
                      "text_visible": "checker is unavailable"
                    }
                  }
                }
              ]
            }
          ]
        }
      ],
      "next": "WaitForResults"
    },
    {
      "type": "sequence",
      "name": "WaitForResults",
      "description": "Wait for address details page to fully load with retries",
      "steps": [
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "action": "wait",
          "description": "Initial wait for page transition",
          "duration": 3000
        },
        {
          "type": "try",
          "name": "WaitForAddressDetailsPage",
          "description": "Wait for address details page elements with retry",
          "strategies": [
            {
              "name": "Strategy 1: Wait for Exchange Code container class",
              "steps": [
                {
                  "action": "wait_for_selector",
                  "selector": ".ExhangeCodeSetup",
                  "timeout": 30000
                }
              ]
            },
            {
              "name": "Strategy 2: Wait for Featured Products table header",
              "steps": [
                {
                  "action": "wait",
                  "duration": 3000
                },
                {
                  "action": "wait_for_load_state",
                  "state": "networkidle"
                },
                {
                  "action": "wait_for_selector",
                  "selector": "th:has-text('Featured Products')",
                  "timeout": 30000
                }
              ]
            },
            {
              "name": "Strategy 3: Maximum wait for slow pages",
              "steps": [
                {
                  "action": "wait",
                  "duration": 10000
                },
                {
                  "action": "wait_for_load_state",
                  "state": "networkidle"
                }
              ]
            }
          ]
        },
        {
          "action": "wait",
          "description": "Final stabilization wait",
          "duration": 2000
        }
      ],
      "next": "ExtractResults"
    },
    {
      "type": "sequence",
      "name": "ExtractResults",
      "description": "Capture screenshot and extract key values from DOM",
      "steps": [
        {
          "action": "screenshot",
          "save_to": "address_details.png",
          "upload_to_s3": true,
          "include_in_result": true,
          "description": "Capture address details page for cloud extraction"
        },
        {
          "action": "extract_by_llm",
          "description": "Use LLM to extract values from page HTML - more resilient than CSS selectors",
          "fields": [
            {"name": "exchange_code", "description": "Exchange Code value (alphanumeric, e.g. 'LNBOU')"},
            {"name": "l2sid_new_ont", "description": "L2SID (New ONT) value - long alphanumeric string"},
            {"name": "fttp_existing_ont", "description": "FTTP Existing ONT Available - Yes/No or similar"},
            {"name": "fttp_new_ont", "description": "FTTP New ONT Available - Yes/No or similar"},
            {"name": "ont_reference", "description": "ONT Reference for Working status row - alphanumeric ID"},
            {"name": "ont_serial_no", "description": "ONT Serial Number for Working status row - alphanumeric"},
            {"name": "port_service_id", "description": "Port Service ID for Working status row - alphanumeric"},
            {"name": "wbc_fttp_rag", "description": "WBC FTTP RAG status (Green/Amber/Red)"},
            {"name": "premise_type", "description": "Premise Type value"}
          ]
        },
        {
          "action": "navigate",
          "url": "https://bbactotl.btwholesale.com/bbac-ui/totl/totlSearch/#/ADSL/AddressHome",
          "description": "Navigate back to search page for next run"
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        }
      ],
      "end": true
    }
  ]
}
