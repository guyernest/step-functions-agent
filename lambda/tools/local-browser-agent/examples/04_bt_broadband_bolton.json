{
  "name": "BT Broadband - Bolton BL5 3AN",
  "description": "Test BT Broadband availability check for 34-40 Market Street, Bolton. Expected: Exchange LCBOL, L2SID BAAMUH",
  "starting_page": "https://bbactotl.btwholesale.com/bbac-ui/totl/totlSearch/#/ADSL/AddressHome",
  "llm_provider": "openai",
  "llm_model": "gpt-4o-mini",
  "abort_on_error": false,
  "default_delay": 300,
  "screenshot_config": {
    "s3_prefix": "verification",
    "upload_mode": "marked_only"
  },
  "session": {
    "profile_name": "Bt_broadband",
    "required_tags": [
      "bt.com",
      "authenticated"
    ],
    "allow_temp_profile": false,
    "clone_for_parallel": false
  },
  "steps": [
    {
      "action": "wait_for_load_state",
      "description": "Wait for initial page load",
      "state": "networkidle"
    },
    {
      "type": "if",
      "name": "CheckAuthenticationStatus",
      "description": "Detect if login required or already authenticated",
      "condition": {
        "type": "or",
        "conditions": [
          {
            "type": "element_visible",
            "selector": "input[type='password'], input[type='text'][name*='user']",
            "timeout": 3000
          },
          {
            "type": "js_eval",
            "expression": "document.title.toLowerCase().includes('secure authentication') || document.title.toLowerCase().includes('login')"
          }
        ]
      },
      "then": {
        "goto": "PerformLogin"
      },
      "else": {
        "goto": "PerformSearch"
      }
    },
    {
      "type": "sequence",
      "name": "PerformLogin",
      "description": "Complete login flow with password manager support",
      "steps": [
        {
          "type": "try",
          "name": "FillUsername",
          "strategies": [
            {
              "name": "Strategy 1: By name attribute",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[type='text'][name*='user'], input[type='email']"
                  },
                  "value": "{{username}}"
                }
              ]
            },
            {
              "name": "Strategy 2: First text input",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[type='text']:first-of-type"
                  },
                  "value": "{{username}}"
                }
              ]
            }
          ]
        },
        {
          "type": "try",
          "name": "ClickNextAfterUsername",
          "strategies": [
            {
              "name": "Strategy 1: Submit button",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "button[type='submit']"
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Next button",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "Next"
                  }
                }
              ]
            }
          ]
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "type": "if",
          "name": "CheckPasswordPage",
          "description": "Wait for password page to load (SPA may take time to render)",
          "condition": {
            "type": "element_visible",
            "selector": "input[type='password']",
            "timeout": 60000
          },
          "then": {
            "type": "sequence",
            "steps": [
              {
                "action": "wait",
                "description": "Wait for password manager autofill",
                "duration": 4000
              },
              {
                "type": "if",
                "name": "CheckPasswordAutofilled",
                "condition": {
                  "type": "js_eval",
                  "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                },
                "then": {
                  "continue": true
                },
                "else": {
                  "type": "try",
                  "name": "FillPasswordWithPasswordManager",
                  "strategies": [
                    {
                      "name": "Strategy 1: Tab + Enter",
                      "steps": [
                        {
                          "action": "click",
                          "locator": {
                            "strategy": "selector",
                            "value": "input[type='password']"
                          },
                          "trigger_autofill": true
                        },
                        {
                          "action": "wait",
                          "duration": 1500
                        },
                        {
                          "action": "press",
                          "key": "Tab",
                          "delay": 300
                        },
                        {
                          "action": "press",
                          "key": "Enter",
                          "delay": 300
                        },
                        {
                          "action": "wait",
                          "duration": 1000
                        }
                      ],
                      "verify": {
                        "type": "js_eval",
                        "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                      }
                    },
                    {
                      "name": "Strategy 2: Vision LLM",
                      "escalate": {
                        "type": "vision_llm",
                        "prompt": "A password manager dropdown has appeared. Click on the first saved password entry in the dropdown to select it and fill the password.",
                        "timeout": 25000,
                        "max_actions": 5
                      },
                      "verify": {
                        "type": "js_eval",
                        "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                      }
                    },
                    {
                      "name": "Strategy 3: Manual",
                      "steps": [
                        {
                          "action": "click",
                          "locator": {
                            "strategy": "selector",
                            "value": "input[type='password']"
                          },
                          "trigger_autofill": true
                        },
                        {
                          "action": "wait",
                          "description": "Wait for manual password selection",
                          "duration": 30000
                        }
                      ],
                      "verify": {
                        "type": "js_eval",
                        "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                      }
                    }
                  ]
                }
              },
              {
                "action": "wait",
                "description": "Brief pause before clicking submit",
                "duration": 1000
              },
              {
                "type": "try",
                "name": "ClickNextAfterPassword",
                "strategies": [
                  {
                    "name": "Strategy 1: Next button by ID",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "selector",
                          "value": "button#next"
                        }
                      }
                    ]
                  },
                  {
                    "name": "Strategy 2: Submit button",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "selector",
                          "value": "button[type='submit']"
                        }
                      }
                    ]
                  },
                  {
                    "name": "Strategy 3: Sign In button by text",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "text",
                          "value": "Sign In"
                        }
                      }
                    ]
                  },
                  {
                    "name": "Strategy 4: Login button by text",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "text",
                          "value": "Login"
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        {
          "action": "wait_for_load_state",
          "description": "Wait for SSO redirect",
          "state": "networkidle"
        },
        {
          "action": "wait",
          "duration": 2000
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "type": "if",
          "name": "VerifyLoginSuccess",
          "condition": {
            "type": "js_eval",
            "expression": "!document.querySelector('input[type=\"password\"]') && (window.location.href.includes('btwholesale') || window.location.href.includes('bbactotl'))"
          },
          "then": {
            "continue": true
          },
          "else": {
            "action": "error",
            "message": "Login failed - still on authentication page"
          }
        }
      ],
      "next": "PerformSearch"
    },
    {
      "type": "sequence",
      "name": "PerformSearch",
      "description": "Search for broadband availability",
      "steps": [
        {
          "type": "if",
          "name": "CheckIfOnAddressHomePage",
          "description": "Check if we're on the correct AddressHome page, if not navigate there",
          "condition": {
            "type": "or",
            "conditions": [
              {
                "type": "element_visible",
                "selector": "input[name='PostCode'], input[name='postcode'], input[id*='postcode' i]",
                "timeout": 3000
              },
              {
                "type": "url_contains",
                "pattern": "AddressHome"
              }
            ]
          },
          "then": {
            "continue": true
          },
          "else": {
            "type": "sequence",
            "description": "Navigate to AddressHome page",
            "steps": [
              {
                "type": "try",
                "name": "NavigateToAddressHome",
                "description": "Try clicking tab first, then direct navigation",
                "strategies": [
                  {
                    "name": "Strategy 1: Click Address Checker link by ID",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "selector",
                          "value": "a#addressNav"
                        }
                      },
                      {
                        "action": "wait_for_load_state",
                        "state": "networkidle"
                      }
                    ]
                  },
                  {
                    "name": "Strategy 2: Direct navigation to AddressHome",
                    "steps": [
                      {
                        "action": "navigate",
                        "url": "https://bbactotl.btwholesale.com/bbac-ui/totl/totlSearch/#/ADSL/AddressHome"
                      },
                      {
                        "action": "wait_for_load_state",
                        "state": "networkidle"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        {
          "action": "wait",
          "description": "Wait for Angular app to stabilize",
          "duration": 1000
        },
        {
          "type": "if",
          "name": "VerifySearchPageLoaded",
          "condition": {
            "type": "element_visible",
            "selector": "input[name='PostCode'], input[name='postcode'], input[id*='postcode' i]",
            "timeout": 5000
          },
          "then": {
            "continue": true
          },
          "else": {
            "action": "error",
            "message": "Postcode field not found on search page after navigation attempts"
          }
        },
        {
          "type": "try",
          "name": "FillPostcode",
          "description": "Fill postcode field - uses smart form_field strategy for Angular Material forms",
          "strategies": [
            {
              "name": "Strategy 1: Smart form_field (handles Angular Material, MUI, etc.)",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "form_field",
                    "label": "PostCode",
                    "field_type": "input"
                  },
                  "value": "BL5 3AN"
                }
              ]
            },
            {
              "name": "Strategy 2: By ID #postCode",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "#postCode"
                  },
                  "value": "BL5 3AN"
                }
              ]
            },
            {
              "name": "Strategy 3: By name attribute",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[name='postCode']"
                  },
                  "value": "BL5 3AN"
                }
              ]
            }
          ]
        },
        {
          "type": "try",
          "name": "ClickSearch",
          "description": "Click search button - includes retry for temporary 'service unavailable' errors",
          "strategies": [
            {
              "name": "Strategy 1: Submit button with retry",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "button[type='submit']"
                  },
                  "delay": 500,
                  "retry": {
                    "attempts": 3,
                    "delay_ms": 1000,
                    "retry_if": {
                      "text_visible": "service unavailable"
                    }
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Text search with retry",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "Search"
                  },
                  "delay": 500,
                  "retry": {
                    "attempts": 3,
                    "delay_ms": 1000,
                    "retry_if": {
                      "text_visible": "service unavailable"
                    }
                  }
                }
              ]
            }
          ]
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        }
      ],
      "next": "SelectAddress"
    },
    {
      "type": "sequence",
      "name": "SelectAddress",
      "description": "Select address from list if present",
      "steps": [
        {
          "type": "try",
          "name": "SelectAddressFromList",
          "description": "Progressive address matching: regex -> fuzzy -> vision with scroll",
          "strategies": [
            {
              "name": "Strategy 1: Regex - building + first word only",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "text=/^\\s*34-40\\s+\\w+/i",
                    "nth": 0
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Regex - building + street flexible",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "text=/34-40[\\s,]+Market Street/i",
                    "nth": 0
                  }
                }
              ]
            },
            {
              "name": "Strategy 3: Regex - street anywhere after building",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "text=/34-40.*Market Street/i",
                    "nth": 0
                  }
                }
              ]
            },
            {
              "name": "Strategy 4: Exact text match",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "34-40 Market Street"
                  }
                }
              ]
            },
            {
              "name": "Strategy 5: Vision LLM with scroll capability",
              "escalate": {
                "type": "vision_llm",
                "prompt": "Find and click the address matching '34-40 Market Street, Westhoughton, Bolton BL5 3AN' in the address list. CRITICAL INSTRUCTIONS:\n\n1. FIRST SEARCH: Look carefully at ALL visible addresses for one containing:\n   - Building number: '34-40'\n   - Street name: 'Market Street'\n   - Format may vary (case, commas, word order)\n\n2. IF FOUND: Click it immediately\n\n3. IF NOT VISIBLE:\n   a) The list is likely SCROLLABLE - look for:\n      - A dropdown/select element that can be scrolled\n      - Scroll arrows (up/down)\n      - A scrollbar on the address list\n   b) SCROLL DOWN within the list (not the whole page)\n   c) After scrolling, SEARCH AGAIN for the address\n   d) Repeat: scroll -> search -> scroll -> search (up to 3 scroll attempts)\n\n4. MATCHING RULES:\n   - Accept variations: '34-40 Market Street', '34-40, Market Street', '34-40 Market Street, City'\n   - Case-insensitive matching\n   - Must have BOTH building number AND street name\n\n5. MAX ACTIONS: 8 actions total (including scrolls and clicks)\n\n6. IF STILL NOT FOUND: Report failure.",
                "timeout": 30000,
                "max_actions": 8
              }
            }
          ]
        },
        {
          "action": "wait",
          "description": "Wait before clicking submit to avoid bot detection",
          "duration": 500
        },
        {
          "type": "try",
          "name": "ClickContinueAfterAddress",
          "description": "Click submit with retry for 'service unavailable' errors",
          "strategies": [
            {
              "name": "Strategy 1: Submit button with retry",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "button[type='submit']"
                  },
                  "delay": 300,
                  "retry": {
                    "attempts": 5,
                    "delay_ms": 3000,
                    "retry_if": {
                      "text_visible": "service unavailable"
                    }
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Continue button with retry",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "Continue"
                  },
                  "delay": 300,
                  "retry": {
                    "attempts": 5,
                    "delay_ms": 3000,
                    "retry_if": {
                      "text_visible": "service unavailable"
                    }
                  }
                }
              ]
            }
          ]
        }
      ],
      "next": "WaitForResults"
    },
    {
      "type": "sequence",
      "name": "WaitForResults",
      "description": "Wait for address details page to fully load with retries",
      "steps": [
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "action": "wait",
          "description": "Initial wait for page transition",
          "duration": 3000
        },
        {
          "type": "try",
          "name": "WaitForAddressDetailsPage",
          "description": "Wait for address details page elements with retry",
          "strategies": [
            {
              "name": "Strategy 1: Wait for Exchange Code container class",
              "steps": [
                {
                  "action": "wait_for_selector",
                  "selector": ".ExhangeCodeSetup",
                  "timeout": 15000
                }
              ]
            },
            {
              "name": "Strategy 2: Wait for Featured Products table header",
              "steps": [
                {
                  "action": "wait",
                  "duration": 3000
                },
                {
                  "action": "wait_for_load_state",
                  "state": "networkidle"
                },
                {
                  "action": "wait_for_selector",
                  "selector": "th:has-text('Featured Products')",
                  "timeout": 20000
                }
              ]
            },
            {
              "name": "Strategy 3: Maximum wait for slow pages",
              "steps": [
                {
                  "action": "wait",
                  "duration": 10000
                },
                {
                  "action": "wait_for_load_state",
                  "state": "networkidle"
                }
              ]
            }
          ]
        },
        {
          "action": "wait",
          "description": "Final stabilization wait",
          "duration": 2000
        }
      ],
      "next": "ExtractResults"
    },
    {
      "type": "sequence",
      "name": "ExtractResults",
      "description": "Capture screenshot and extract key values from DOM",
      "steps": [
        {
          "action": "screenshot",
          "save_to": "address_details.png",
          "upload_to_s3": true,
          "include_in_result": true,
          "description": "Capture address details page for cloud extraction"
        },
        {
          "action": "extract_dom",
          "description": "Extract Exchange Code, L2SID, and ONT Details from page HTML",
          "extractions": [
            {
              "name": "exchange_code",
              "selector": ".ExhangeCodeSetup > span:last-child",
              "fallback_js": "(() => { const wrapper = document.querySelector('.ExhangeCodeSetup'); if (wrapper) { const spans = wrapper.querySelectorAll('span'); for (const s of spans) { if (!s.classList.contains('ExhangeCodeSetupTwo') && s.textContent.trim() && !s.textContent.includes('Exchange Code')) { return s.textContent.trim(); } } } return null; })()"
            },
            {
              "name": "l2sid_new_ont",
              "selector": "tr:has(th:has-text('L2SID (New ONT)')) td",
              "fallback_js": "(() => { const rows = document.querySelectorAll('tr'); for (const r of rows) { const th = r.querySelector('th'); if (th && th.textContent.includes('L2SID (New ONT)')) { const td = r.querySelector('td'); return td ? td.textContent.trim() : null; } } return null; })()"
            },
            {
              "name": "fttp_existing_ont",
              "selector": "tr:has(th:has-text('FTTP Existing ONT Available')) td",
              "fallback_js": "(() => { const rows = document.querySelectorAll('tr'); for (const r of rows) { const th = r.querySelector('th'); if (th && th.textContent.includes('FTTP Existing ONT Available')) { const td = r.querySelector('td'); return td ? td.textContent.trim() : null; } } return null; })()"
            },
            {
              "name": "fttp_new_ont",
              "selector": "tr:has(th:has-text('FTTP New ONT Available')) td",
              "fallback_js": "(() => { const rows = document.querySelectorAll('tr'); for (const r of rows) { const th = r.querySelector('th'); if (th && th.textContent.includes('FTTP New ONT Available')) { const td = r.querySelector('td'); return td ? td.textContent.trim() : null; } } return null; })()"
            },
            {
              "name": "ont_reference",
              "selector": "table:has(th:has-text('ONT Details')) tr:has(td:has-text('Working')) td:nth-child(2)",
              "fallback_js": "(() => { const tables = document.querySelectorAll('table'); for (const t of tables) { const header = t.querySelector('th'); if (header && header.textContent.includes('ONT Details')) { const rows = t.querySelectorAll('tr'); for (const r of rows) { if (r.textContent.includes('Working')) { const cells = r.querySelectorAll('td'); return cells[1]?.textContent?.trim() || null; } } } } return null; })()"
            },
            {
              "name": "ont_serial_no",
              "selector": "table:has(th:has-text('ONT Details')) tr:has(td:has-text('Working')) td:nth-child(3)",
              "fallback_js": "(() => { const tables = document.querySelectorAll('table'); for (const t of tables) { const header = t.querySelector('th'); if (header && header.textContent.includes('ONT Details')) { const rows = t.querySelectorAll('tr'); for (const r of rows) { if (r.textContent.includes('Working')) { const cells = r.querySelectorAll('td'); return cells[2]?.textContent?.trim() || null; } } } } return null; })()"
            },
            {
              "name": "port_service_id",
              "selector": "table:has(th:has-text('ONT Details')) tr:has(td:has-text('Working')) td:nth-child(4)",
              "fallback_js": "(() => { const tables = document.querySelectorAll('table'); for (const t of tables) { const header = t.querySelector('th'); if (header && header.textContent.includes('ONT Details')) { const rows = t.querySelectorAll('tr'); for (const r of rows) { if (r.textContent.includes('Working')) { const cells = r.querySelectorAll('td'); return cells[3]?.textContent?.trim() || null; } } } } return null; })()"
            },
            {
              "name": "wbc_fttp_rag",
              "selector": "tr:has(th:has-text('WBC FTTP')) td:first-of-type",
              "fallback_js": "(() => { const rows = document.querySelectorAll('tr'); for (const r of rows) { const th = r.querySelector('th'); if (th && th.textContent.includes('WBC FTTP')) { const td = r.querySelector('td'); return td ? td.textContent.trim() : null; } } return null; })()"
            },
            {
              "name": "premise_type",
              "selector": "tr:has(th:has-text('Premise Type')) td",
              "fallback_js": "(() => { const rows = document.querySelectorAll('tr'); for (const r of rows) { const th = r.querySelector('th'); if (th && th.textContent.includes('Premise Type')) { const td = r.querySelector('td'); return td ? td.textContent.trim() : null; } } return null; })()"
            }
          ]
        }
      ],
      "end": true
    }
  ]
}