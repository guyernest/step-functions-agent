{
  "name": "BT Broadband Availability Checker (Optimized with Skip-Login)",
  "description": "Optimized workflow that detects authentication state and skips login when already authenticated",
  "starting_page": "https://bbactotl.btwholesale.com/bbac-ui/totl/totlSearch/#/ADSL/AddressHome",
  "llm_provider": "openai",
  "llm_model": "gpt-4o-mini",
  "abort_on_error": false,
  "session": {
    "profile_name": "Bt_broadband",
    "clone_for_parallel": false
  },
  "steps": [
    {
      "action": "wait_for_load_state",
      "description": "Wait for initial page load",
      "state": "networkidle"
    },
    {
      "action": "screenshot",
      "description": "Initial page state",
      "save_to": "01_initial.png"
    },
    {
      "type": "if",
      "name": "CheckAuthenticationStatus",
      "description": "Detect if login required or already authenticated",
      "condition": {
        "type": "or",
        "conditions": [
          {
            "type": "element_visible",
            "selector": "input[type='password'], input[type='text'][name*='user']",
            "timeout": 3000
          },
          {
            "type": "js_eval",
            "expression": "document.title.toLowerCase().includes('secure authentication') || document.title.toLowerCase().includes('login')"
          }
        ]
      },
      "then": {
        "goto": "PerformLogin"
      },
      "else": {
        "goto": "PerformSearch"
      }
    },
    {
      "type": "sequence",
      "name": "PerformLogin",
      "description": "Complete login flow with password manager support",
      "steps": [
        {
          "type": "try",
          "name": "FillUsername",
          "strategies": [
            {
              "name": "Strategy 1: By name attribute",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[type='text'][name*='user'], input[type='email']"
                  },
                  "value": "nterizakis"
                }
              ]
            },
            {
              "name": "Strategy 2: First text input",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[type='text']:first-of-type"
                  },
                  "value": "nterizakis"
                }
              ]
            }
          ]
        },
        {
          "type": "try",
          "name": "ClickNextAfterUsername",
          "strategies": [
            {
              "name": "Strategy 1: Submit button",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "button[type='submit']"
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Next button",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "Next"
                  }
                }
              ]
            }
          ]
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "type": "if",
          "name": "CheckPasswordPage",
          "condition": {
            "type": "element_visible",
            "selector": "input[type='password']",
            "timeout": 10000
          },
          "then": {
            "type": "sequence",
            "steps": [
              {
                "action": "wait",
                "description": "Wait for autofill",
                "duration": 2000
              },
              {
                "type": "if",
                "name": "CheckPasswordAutofilled",
                "condition": {
                  "type": "js_eval",
                  "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                },
                "then": {
                  "continue": true
                },
                "else": {
                  "type": "try",
                  "name": "FillPasswordWithPasswordManager",
                  "strategies": [
                    {
                      "name": "Strategy 1: Tab + Enter",
                      "steps": [
                        {
                          "action": "click",
                          "locator": {
                            "strategy": "selector",
                            "value": "input[type='password']"
                          },
                          "trigger_autofill": true
                        },
                        {
                          "action": "wait",
                          "duration": 1500
                        },
                        {
                          "action": "press",
                          "key": "Tab",
                          "delay": 300
                        },
                        {
                          "action": "press",
                          "key": "Enter",
                          "delay": 300
                        },
                        {
                          "action": "wait",
                          "duration": 1000
                        }
                      ],
                      "verify": {
                        "type": "js_eval",
                        "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                      }
                    },
                    {
                      "name": "Strategy 2: Vision LLM",
                      "escalate": {
                        "type": "vision_llm",
                        "prompt": "A password manager dropdown has appeared. Click on the first saved password entry in the dropdown to select it and fill the password.",
                        "timeout": 25000,
                        "max_actions": 5
                      },
                      "verify": {
                        "type": "js_eval",
                        "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                      }
                    },
                    {
                      "name": "Strategy 3: Manual",
                      "steps": [
                        {
                          "action": "click",
                          "locator": {
                            "strategy": "selector",
                            "value": "input[type='password']"
                          },
                          "trigger_autofill": true
                        },
                        {
                          "action": "wait",
                          "description": "Wait for manual password selection",
                          "duration": 30000
                        }
                      ],
                      "verify": {
                        "type": "js_eval",
                        "expression": "document.querySelector('input[type=\"password\"]')?.value?.length > 0"
                      }
                    }
                  ]
                }
              },
              {
                "type": "try",
                "name": "ClickNextAfterPassword",
                "strategies": [
                  {
                    "name": "Strategy 1: Next button by ID",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "selector",
                          "value": "button#next"
                        }
                      }
                    ]
                  },
                  {
                    "name": "Strategy 2: Submit button",
                    "steps": [
                      {
                        "action": "click",
                        "locator": {
                          "strategy": "selector",
                          "value": "button[type='submit']"
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        {
          "action": "wait_for_load_state",
          "description": "Wait for SSO redirect",
          "state": "networkidle"
        },
        {
          "action": "wait",
          "duration": 2000
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "action": "screenshot",
          "save_to": "02_after_login.png"
        },
        {
          "type": "if",
          "name": "VerifyLoginSuccess",
          "condition": {
            "type": "js_eval",
            "expression": "!document.querySelector('input[type=\"password\"]') && (window.location.href.includes('btwholesale') || window.location.href.includes('bbactotl'))"
          },
          "then": {
            "continue": true
          },
          "else": {
            "action": "error",
            "message": "Login failed - still on authentication page"
          }
        }
      ],
      "next": "PerformSearch"
    },
    {
      "type": "sequence",
      "name": "PerformSearch",
      "description": "Search for broadband availability",
      "steps": [
        {
          "action": "screenshot",
          "save_to": "03_search_page.png"
        },
        {
          "type": "if",
          "name": "VerifySearchPageLoaded",
          "condition": {
            "type": "element_visible",
            "selector": "input[name='PostCode'], input[name='postcode'], input[id*='postcode' i]",
            "timeout": 5000
          },
          "then": {
            "continue": true
          },
          "else": {
            "action": "error",
            "message": "Postcode field not found on search page"
          }
        },
        {
          "type": "try",
          "name": "FillPostcode",
          "strategies": [
            {
              "name": "Strategy 1: By name PostCode",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[name='PostCode']"
                  },
                  "value": "CB7 5LG"
                }
              ]
            },
            {
              "name": "Strategy 2: By name postcode",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[name='postcode']"
                  },
                  "value": "CB7 5LG"
                }
              ]
            },
            {
              "name": "Strategy 3: By ID containing postcode",
              "steps": [
                {
                  "action": "fill",
                  "locator": {
                    "strategy": "selector",
                    "value": "input[id*='postcode' i]"
                  },
                  "value": "CB7 5LG"
                }
              ]
            }
          ]
        },
        {
          "type": "try",
          "name": "ClickSearch",
          "strategies": [
            {
              "name": "Strategy 1: Submit button",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "button[type='submit']"
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Text search",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "Search"
                  }
                }
              ]
            }
          ]
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "action": "screenshot",
          "save_to": "04_after_search.png"
        }
      ],
      "next": "SelectAddress"
    },
    {
      "type": "sequence",
      "name": "SelectAddress",
      "description": "Select address from list if present",
      "steps": [
        {
          "action": "screenshot",
          "save_to": "04b_before_address_selection.png"
        },
        {
          "type": "try",
          "name": "SelectAddressFromList",
          "description": "Progressive address matching: regex → fuzzy → vision with scroll",
          "strategies": [
            {
              "name": "Strategy 1: Regex - building + first word only",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "text=/^\\s*40\\s+\\w+/i",
                    "nth": 0
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Regex - building + street flexible",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "text=/40[\\s,]+Withers Place/i",
                    "nth": 0
                  }
                }
              ]
            },
            {
              "name": "Strategy 3: Regex - street anywhere after building",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "text=/40.*Withers Place/i",
                    "nth": 0
                  }
                }
              ]
            },
            {
              "name": "Strategy 4: Exact text match",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "40 Withers Place"
                  }
                }
              ]
            },
            {
              "name": "Strategy 5: Vision LLM with scroll capability",
              "escalate": {
                "type": "vision_llm",
                "prompt": "Find and click the address matching '40 Withers Place, Fordham, Ely, Cambridgeshire, CB7 5LG' in the address list. CRITICAL INSTRUCTIONS:\n\n1. FIRST SEARCH: Look carefully at ALL visible addresses for one containing:\n   - Building number: '40'\n   - Street name: 'Withers Place'\n   - Format may vary (case, commas, word order)\n\n2. IF FOUND: Click it immediately\n\n3. IF NOT VISIBLE:\n   a) The list is likely SCROLLABLE - look for:\n      - A dropdown/select element that can be scrolled\n      - Scroll arrows (up/down)\n      - A scrollbar on the address list\n   b) SCROLL DOWN within the list (not the whole page)\n   c) After scrolling, SEARCH AGAIN for the address\n   d) Repeat: scroll → search → scroll → search (up to 3 scroll attempts)\n\n4. MATCHING RULES:\n   - Accept variations: '40 Withers Place', '40, Withers Place', '40 Withers Place, City'\n   - Case-insensitive matching\n   - Must have BOTH building number AND street name\n\n5. MAX ACTIONS: 8 actions total (including scrolls and clicks)\n\n6. IF STILL NOT FOUND: Click the closest match by building number, or report failure.",
                "timeout": 30000,
                "max_actions": 8
              }
            }
          ]
        },
        {
          "type": "try",
          "name": "ClickContinueAfterAddress",
          "strategies": [
            {
              "name": "Strategy 1: Submit button",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "selector",
                    "value": "button[type='submit']"
                  }
                }
              ]
            },
            {
              "name": "Strategy 2: Continue button",
              "steps": [
                {
                  "action": "click",
                  "locator": {
                    "strategy": "text",
                    "value": "Continue"
                  }
                }
              ]
            }
          ]
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "action": "wait",
          "duration": 3000
        },
        {
          "action": "wait_for_load_state",
          "state": "networkidle"
        },
        {
          "action": "screenshot",
          "save_to": "05_packages.png"
        }
      ],
      "next": "ExtractResults"
    },
    {
      "type": "sequence",
      "name": "ExtractResults",
      "description": "Extract broadband availability data",
      "steps": [
        {
          "action": "extract",
          "method": "vision",
          "prompt": "Extract broadband availability information from the results page following these steps: 1. ALWAYS CAPTURE (if visible):   - ALK (Access Line Key) - usually displayed near top  - Exchange Code - BT exchange identifier 2. CHECK FEATURED PRODUCTS SECTION:  Look for a section called 'Featured Products'.   Search for a row/line containing 'WBC FTTP'. 3. IF 'WBC FTTP' IS FOUND:  - Set fttp_avail = true   - From the WBC FTTP row, capture 'Downstream Line Rate' (this is the SOADSL DSL speed in Mbps).   Then navigate to OTHER SECTIONS:   a) OTHER OFFERINGS section:     - Check if ANY row has 'Service Availability' field = 'Enabled'    - If found, set sogea_avail = true, otherwise false.   b) ONT DETAILS section:  - Find the LAST row in this section   - Capture: 'Reference' field (this is ont_reference)   - Capture: 'ONT Serial Number' field (this is ont_serial_no)    - Capture: 'Port Service ID' field (this is port_service_id)   c) PREMISE ENVIRONMENT section:      - Capture: 'Recommended Minimum SVR NLP' field (this is install_type)    - Valid values are typically 'Standard' or 'Premium'. 4. IF 'WBC FTTP' IS NOT FOUND:   - Set fttp_avail = false  - Leave all FTTP-related fields blank (install_type, sogea_avail, soadsl_dsl_speed, ont_reference, ont_serial_no, port_service_id). IMPORTANT: fttp_avail is REQUIRED and must always be set to true or false based on whether WBC FTTP is present in Featured Products.",
          "schema": {
            "type": "object",
            "properties": {
              "alk": {
                "type": "string",
                "description": "Access Line Key identifier (e.g., A00022059784)"
              },
              "exchange_code": {
                "type": "string",
                "description": "BT exchange code (e.g., CAMBRIDGE)"
              },
              "fttp_avail": {
                "type": "boolean",
                "description": "Whether WBC FTTP is found in the Featured Products section"
              },
              "install_type": {
                "type": "string",
                "enum": [
                  "Standard",
                  "Premium",
                  "N/A"
                ],
                "description": "Value from Premise Environment -> Recommended Minimum SVR NLP (only if WBC FTTP found)"
              },
              "sogea_avail": {
                "type": "boolean",
                "description": "Whether Other Offerings has Service Availability = Enabled (only if WBC FTTP found)"
              },
              "soadsl_dsl_speed": {
                "type": "number",
                "description": "Downstream Line Rate from WBC FTTP row in Mbps (only if WBC FTTP found)"
              },
              "ont_reference": {
                "type": "string",
                "description": "Reference field from last row of ONT Details section (only if WBC FTTP found)"
              },
              "ont_serial_no": {
                "type": "string",
                "description": "ONT Serial Number from last row of ONT Details section (only if WBC FTTP found)"
              },
              "port_service_id": {
                "type": "string",
                "description": "Port Service ID from last row of ONT Details section (only if WBC FTTP found)"
              }
            },
            "required": [
              "fttp_avail"
            ]
          }
        },
        {
          "action": "screenshot",
          "save_to": "06_final.png"
        }
      ],
      "end": true
    }
  ]
}
