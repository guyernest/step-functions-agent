{
  "name": "BT Broadband Availability Checker (Password Manager Support)",
  "description": "Check broadband availability with improved password manager autofill support using progressive escalation from DOM → Playwright → Vision",
  "llm_provider": "openai",
  "llm_model": "gpt-4o-mini",
  "starting_page": "https://bbactotl.btwholesale.com/bbac-ui/totl/totlSearch/#/ADSL/AddressHome",
  "abort_on_error": false,
  "session": {
    "profile_name": "Bt_broadband",
    "clone_for_parallel": false
  },
  "steps": [
    {
      "type": "wait_for_load_state",
      "description": "Wait for initial page to fully load",
      "state": "networkidle"
    },
    {
      "type": "screenshot",
      "description": "Screenshot of initial page",
      "save_to": "01_initial_page.png"
    },
    {
      "type": "execute_js",
      "description": "Check page state - DOM method (fastest)",
      "script": "(function() { var title = document.title.toLowerCase(); return { title: document.title, url: window.location.href, isLoginPage: title.includes('secure authentication') || title.includes('login') || title.includes('sign in'), hasLoginForm: !!document.querySelector('input[type=\"password\"]'), hasSearchForm: !!document.querySelector('input[name=\"postcode\"], input[id*=\"postcode\"], input[placeholder*=\"postcode\"]') }; })()"
    },
    {
      "type": "extract",
      "description": "Identify page type using vision (if DOM unclear)",
      "method": "vision",
      "prompt": "Analyze this BT Wholesale webpage and determine: 1) Is this a login/authentication page (might show 'Secure Authentication'), a search/checker page, or results page? 2) What is the main call-to-action? 3) Are there any error messages or notices visible?",
      "schema": {
        "type": "object",
        "properties": {
          "page_type": {
            "type": "string",
            "enum": ["login", "search", "results", "error", "other"],
            "description": "Type of page currently displayed"
          },
          "main_cta": {
            "type": "string",
            "description": "Main call-to-action or heading"
          },
          "has_errors": {
            "type": "boolean",
            "description": "Whether error messages are visible"
          },
          "error_message": {
            "type": "string",
            "description": "Error message text if visible, empty string otherwise"
          },
          "confidence": {
            "type": "number",
            "description": "Confidence in page type identification (0.0-1.0)"
          }
        },
        "required": ["page_type", "main_cta", "has_errors", "confidence"]
      }
    },
    {
      "type": "fill",
      "description": "Enter username (if on login page)",
      "escalation_chain": [
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "input[type='text'][name*='user'], input[type='text'][name*='username'], input[type='email']"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "input[type='text']:first-of-type"
          },
          "confidence_threshold": 0.8
        },
        {
          "method": "vision_find_element",
          "prompt": "Find the username or email input field on this login page. This is typically the first text input field.",
          "prefer": "selector",
          "fallback": "text",
          "confidence_threshold": 0.7
        }
      ],
      "value": "nterizakis"
    },
    {
      "type": "click",
      "description": "Click Next/Continue button after username",
      "escalation_chain": [
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "button[type='submit']"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "Next"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "Continue"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "vision_find_element",
          "prompt": "Find the Next or Continue button after entering username. This is typically a submit button or primary action button.",
          "prefer": "selector",
          "fallback": "coordinates",
          "confidence_threshold": 0.7
        }
      ]
    },
    {
      "type": "wait",
      "description": "Wait for password field to appear",
      "locator": {
        "strategy": "selector",
        "value": "input[type='password']"
      },
      "timeout": 30000
    },
    {
      "type": "wait_for_load_state",
      "description": "Wait for page to stabilize",
      "state": "networkidle"
    },
    {
      "type": "screenshot",
      "description": "Screenshot of password page",
      "save_to": "01b_after_username.png"
    },
    {
      "type": "wait",
      "description": "Wait for browser autofill to complete",
      "duration": 2000
    },
    {
      "type": "execute_js",
      "description": "Check if password was autofilled",
      "script": "(function() { var pwdField = document.querySelector('input[type=\"password\"]'); return { passwordFilled: pwdField ? pwdField.value.length > 0 : false, passwordLength: pwdField ? pwdField.value.length : 0, hasPasswordField: !!pwdField }; })()"
    },
    {
      "type": "click",
      "description": "Click password field to activate password manager",
      "trigger_autofill": true,
      "escalation_chain": [
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "input[type='password']"
          },
          "confidence_threshold": 0.9
        }
      ]
    },
    {
      "type": "wait",
      "description": "Wait for password manager dropdown to appear",
      "duration": 10000
    },
    {
      "type": "press",
      "description": "Select password from manager (Arrow Down + Enter)",
      "keys": ["ArrowDown", "Enter"],
      "delay": 5000
    },
    {
      "type": "execute_js",
      "description": "Verify password was filled after password manager interaction",
      "script": "(function() { var pwdField = document.querySelector('input[type=\"password\"]'); var filled = pwdField && pwdField.value.length > 0; return { passwordFilled: filled, passwordLength: pwdField ? pwdField.value.length : 0, hasPasswordField: !!pwdField }; })()"
    },
    {
      "type": "wait",
      "description": "Wait for password to fill from manager",
      "duration": 500
    },
    {
      "type": "click",
      "description": "Click Next button on password page",
      "escalation_chain": [
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "button#next"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "Next"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "button[type='submit']"
          },
          "confidence_threshold": 0.9
        }
      ]
    },
    {
      "type": "wait_for_load_state",
      "description": "Wait for initial redirect after login",
      "state": "networkidle"
    },
    {
      "type": "wait",
      "description": "Wait for SSO redirect to complete (BT portal)",
      "duration": 3000
    },
    {
      "type": "wait_for_load_state",
      "description": "Wait for BT wholesale portal to fully load",
      "state": "networkidle"
    },
    {
      "type": "screenshot",
      "description": "Screenshot after login and SSO redirect",
      "save_to": "02_after_login.png"
    },
    {
      "type": "execute_js",
      "description": "Verify we're on BT wholesale portal",
      "script": "(function() { var url = window.location.href; var hash = window.location.hash; return { url: url, hash: hash, onBTWholesale: url.includes('bbactotl.btwholesale.com') || url.includes('btwholesale'), currentPage: hash }; })()"
    },
    {
      "type": "navigate",
      "description": "Navigate to Address Checker page",
      "url": "https://bbactotl.btwholesale.com/bbac-ui/totl/totlSearch/#/ADSL/AddressHome"
    },
    {
      "type": "wait_for_load_state",
      "description": "Wait for Address Checker page to load",
      "state": "networkidle"
    },
    {
      "type": "screenshot",
      "description": "Screenshot of Address Checker page",
      "save_to": "02b_address_checker.png"
    },
    {
      "type": "execute_js",
      "description": "Verify Address Checker page loaded",
      "script": "(function() { var url = window.location.href; var hash = window.location.hash; var postcodeInput = document.querySelector('input[name*=\"postcode\"], input[id*=\"postcode\"], input[placeholder*=\"postcode\" i]'); return { url: url, hash: hash, hasPostcodeField: !!postcodeInput, postcodeFieldVisible: postcodeInput ? window.getComputedStyle(postcodeInput).display !== 'none' : false, pageTitle: document.title }; })()"
    },
    {
      "type": "wait",
      "description": "Wait for Address Checker form to be ready",
      "duration": 2000
    },
    {
      "type": "fill",
      "description": "Enter postcode in search field",
      "escalation_chain": [
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "input[name='PostCode']"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "input[name='postcode']"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "input[id*='ostcode' i]"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "input[placeholder*='ostcode' i]"
          },
          "confidence_threshold": 0.9
        }
      ],
      "value": "{{postcode}}"
    },
    {
      "type": "click",
      "description": "Click search/check availability button",
      "escalation_chain": [
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "button[type='submit']"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "Check availability"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "Search"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "vision_find_element",
          "prompt": "Find the main search or 'Check availability' button. This should be near the postcode input field. Return the best locator.",
          "prefer": "selector",
          "fallback": "coordinates",
          "confidence_threshold": 0.7
        }
      ]
    },
    {
      "type": "wait_for_load_state",
      "description": "Wait for search results to load",
      "state": "networkidle"
    },
    {
      "type": "screenshot",
      "description": "Screenshot after search",
      "save_to": "02_after_search.png"
    },
    {
      "type": "extract",
      "description": "Check if address selection is needed",
      "method": "vision",
      "prompt": "Look at this page after postcode search. Answer: 1) Does it show a list of addresses to select from? 2) Does it show broadband packages directly? 3) Is there an error or 'no results' message?",
      "schema": {
        "type": "object",
        "properties": {
          "shows_address_list": {
            "type": "boolean",
            "description": "True if multiple addresses are shown for selection"
          },
          "shows_packages": {
            "type": "boolean",
            "description": "True if broadband packages are already visible"
          },
          "has_error": {
            "type": "boolean",
            "description": "True if error or no results message shown"
          },
          "address_count": {
            "type": "integer",
            "description": "Number of addresses visible (0 if none)"
          },
          "needs_scroll": {
            "type": "boolean",
            "description": "True if address list appears scrollable/truncated"
          }
        },
        "required": [
          "shows_address_list",
          "shows_packages",
          "has_error",
          "address_count"
        ]
      }
    },
    {
      "type": "click",
      "description": "Select matching address from list",
      "escalation_chain": [
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "{{full_address}}"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "{{building_number}} {{street}}"
          },
          "confidence_threshold": 0.85
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "{{street}}"
          },
          "confidence_threshold": 0.8
        },
        {
          "method": "vision_find_element",
          "prompt": "Find and click the address list item that matches: {{full_address}}. Look for the closest match in the visible address list. Return the best locator (prefer selector or text over coordinates).",
          "prefer": "text",
          "fallback": "coordinates",
          "confidence_threshold": 0.7
        }
      ]
    },
    {
      "type": "click",
      "description": "Click the submit/continue button after selecting the address",
      "escalation_chain": [
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "selector",
            "value": "button[type='submit']"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "Continue"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "Submit"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "playwright_locator",
          "locator": {
            "strategy": "text",
            "value": "Next"
          },
          "confidence_threshold": 0.9
        },
        {
          "method": "vision_find_element",
          "prompt": "Find the submit, continue, or next button that confirms the address selection. This is typically near the bottom of the address selection form.",
          "prefer": "selector",
          "fallback": "coordinates",
          "confidence_threshold": 0.7
        }
      ]
    },
    {
      "type": "wait_for_load_state",
      "description": "Wait for initial response after submitting address",
      "state": "networkidle"
    },
    {
      "type": "wait",
      "description": "Wait for JavaScript redirect to complete (address details page)",
      "duration": 3000
    },
    {
      "type": "wait_for_load_state",
      "description": "Wait for address details/packages page to fully load",
      "state": "networkidle"
    },
    {
      "type": "screenshot",
      "description": "Screenshot of packages page",
      "save_to": "03_packages.png"
    },
    {
      "type": "extract",
      "description": "Extract all broadband packages with conditional logic",
      "method": "vision",
      "prompt": "Extract broadband availability information from the results page following these steps: 1. ALWAYS CAPTURE (if visible):   - ALK (Access Line Key) - usually displayed near top  - Exchange Code - BT exchange identifier 2. CHECK FEATURED PRODUCTS SECTION:  Look for a section called 'Featured Products'.   Search for a row/line containing 'WBC FTTP'. 3. IF 'WBC FTTP' IS FOUND:  - Set fttp_avail = true   - From the WBC FTTP row, capture 'Downstream Line Rate' (this is the SOADSL DSL speed in Mbps).   Then navigate to OTHER SECTIONS:   a) OTHER OFFERINGS section:     - Check if ANY row has 'Service Availability' field = 'Enabled'    - If found, set sogea_avail = true, otherwise false.   b) ONT DETAILS section:  - Find the LAST row in this section   - Capture: 'Reference' field (this is ont_reference)   - Capture: 'ONT Serial Number' field (this is ont_serial_no)    - Capture: 'Port Service ID' field (this is port_service_id)   c) PREMISE ENVIRONMENT section:      - Capture: 'Recommended Minimum SVR NLP' field (this is install_type)    - Valid values are typically 'Standard' or 'Premium'. 4. IF 'WBC FTTP' IS NOT FOUND:   - Set fttp_avail = false  - Leave all FTTP-related fields blank (install_type, sogea_avail, soadsl_dsl_speed, ont_reference, ont_serial_no, port_service_id). IMPORTANT: fttp_avail is REQUIRED and must always be set to true or false based on whether WBC FTTP is present in Featured Products.",
      "schema": {
        "type": "object",
        "properties": {
          "alk": {
            "type": "string",
            "description": "Access Line Key identifier (e.g., A00022059784)"
          },
          "exchange_code": {
            "type": "string",
            "description": "BT exchange code (e.g., CAMBRIDGE)"
          },
          "fttp_avail": {
            "type": "boolean",
            "description": "Whether WBC FTTP is found in the Featured Products section"
          },
          "install_type": {
            "type": "string",
            "enum": ["Standard", "Premium", "N/A"],
            "description": "Value from Premise Environment -> Recommended Minimum SVR NLP (only if WBC FTTP found)"
          },
          "sogea_avail": {
            "type": "boolean",
            "description": "Whether Other Offerings has Service Availability = Enabled (only if WBC FTTP found)"
          },
          "soadsl_dsl_speed": {
            "type": "number",
            "description": "Downstream Line Rate from WBC FTTP row in Mbps (only if WBC FTTP found)"
          },
          "ont_reference": {
            "type": "string",
            "description": "Reference field from last row of ONT Details section (only if WBC FTTP found)"
          },
          "ont_serial_no": {
            "type": "string",
            "description": "ONT Serial Number from last row of ONT Details section (only if WBC FTTP found)"
          },
          "port_service_id": {
            "type": "string",
            "description": "Port Service ID from last row of ONT Details section (only if WBC FTTP found)"
          }
        },
        "required": ["fttp_avail"]
      }
    },
    {
      "type": "screenshot",
      "description": "Final screenshot for verification",
      "save_to": "04_final.png"
    }
  ]
}
