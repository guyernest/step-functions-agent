"""
broadband_availability_bt_wholesale Agent
Schema-driven browser automation agent generated from canonical schema
Version: 1.0.0
"""

import json
from aws_cdk import (
    Stack,
    Duration,
    CfnOutput,
    Fn,
    aws_stepfunctions as sfn,
    aws_iam as iam,
    Tags
)
from constructs import Construct
from .step_functions_generator_unified_llm import UnifiedLLMStepFunctionsGenerator
from ..shared.base_agent_construct import BaseAgentConstruct


class broadband-availability-bt-wholesale-structuredStack(Stack):
    """
    Schema-generated CDK Stack for broadband_availability_bt_wholesale

    Canonical Schema: broadband_availability_bt_wholesale v1.0.0
    Generated by: schema-factory
    """

    def __init__(self, scope: Construct, id: str, env_name: str = "prod", **kwargs) -> None:
        super().__init__(scope, id, **kwargs)

        self.env_name = env_name
        self.agent_name = "broadband-availability-bt-wholesale-structured"
        self.extraction_name = "broadband_availability_bt_wholesale"

        # Import shared resources
        self.agent_registry_table_name = self.node.try_get_context("agent_registry_table") or f"AgentRegistry-{self.env_name}"
        self.tool_registry_table_name = self.node.try_get_context("tool_registry_table") or f"ToolRegistry-{self.env_name}"
        self.llm_models_table_name = self.node.try_get_context("llm_models_table") or f"LLMModels-{self.env_name}"

        # Import unified LLM ARN
        self.unified_llm_arn = Fn.import_value(f"SharedUnifiedRustLLMLambdaArn-{self.env_name}")

        # Import browser remote tool Lambda ARN and Activity ARN
        self.browser_remote_lambda_arn = Fn.import_value(f"BrowserRemoteLambdaArn-{self.env_name}")
        self.browser_remote_activity_arn = Fn.import_value(f"BrowserRemoteActivityArn-{self.env_name}")

        # System prompt (schema-driven)
        self.system_prompt = """You are a broadband_availability_bt_wholesale assistant that uses browser automation.

IMPORTANT REMOTE EXECUTION NOTICE:
- Your browser automation tasks are executed on a remote local browser via Step Functions Activities
- The local agent uses Nova Act for intelligent browser interactions
- Browser sessions run in a real user environment using the Bt_broadband profile
- Scripts are executed as JSON files that define declarative browser automation steps

YOUR PRIMARY TASK:
Check broadband availability for UK addresses using BT Wholesale Broadband Checker portal

CANONICAL SCHEMA - INPUT:
You will receive:
- building_number: Building number (e.g., &#x27;1&#x27;, &#x27;23A&#x27;) [REQUIRED]
- full_address: Full address for disambiguation when multiple matches exist
- postcode: UK postcode in format like SW1A 1AA [REQUIRED]
- street: Street or road name (e.g., &#x27;High Street&#x27;, &#x27;Park Road&#x27;) [REQUIRED]

CANONICAL SCHEMA - OUTPUT:
You must extract and return:
- availability: Whether broadband service is available
- cabinet: Street cabinet number
- downstream_mbps: Maximum download speed in Mbps
- exchange: BT exchange station name
- metadata: Additional metadata from the extraction
- screenshot_url: URL of browser recording or screenshot
- service_type: Type of broadband service available
- success: Whether the broadband availability check succeeded [REQUIRED]
- upstream_mbps: Maximum upload speed in Mbps

BROWSER AUTOMATION SCRIPT FORMAT:
Provide browser automation as a JSON script following this template structure.

After browser automation:
1. Use browser_remote tool with the JSON script
2. Analyze the extracted structured data
3. Call print_broadband_availability_bt_wholesale_output with all required fields
4. Ensure all data matches the canonical output schema

IMPORTANT: When you have completed the extraction and validated the data, you MUST call the print_broadband_availability_bt_wholesale_output tool to return the structured output. This ensures consistent output formatting across all LLM providers."""

        # Structured output schema (from canonical schema)
        self.structured_output_schema = {
            "type": "object",
            "properties": {
                "availability": {
                    "description": "Whether broadband service is available"
                },
                "cabinet": {
                    "description": "Street cabinet number"
                },
                "downstream_mbps": {
                    "description": "Maximum download speed in Mbps"
                },
                "exchange": {
                    "description": "BT exchange station name"
                },
                "metadata": {
                    "description": "Additional metadata from the extraction"
                },
                "screenshot_url": {
                    "description": "URL of browser recording or screenshot"
                },
                "service_type": {
                    "enum": ["ADSL", "VDSL", "FTTC", "FTTP", "unknown"],
                    "description": "Type of broadband service available"
                },
                "success": {
                    "description": "Whether the broadband availability check succeeded"
                },
                "upstream_mbps": {
                    "description": "Maximum upload speed in Mbps"
                }
            },
            "required": ["success", ]
        }

        # Tool configurations
        self.tool_configs = [
            {
                "tool_name": "browser_remote",
                "lambda_arn": self.browser_remote_lambda_arn,
                "requires_activity": True,
                "activity_type": "remote_execution",
                "activity_arn": self.browser_remote_activity_arn
            }
        ]

        # Generate state machine definition using unified generator
        state_machine_definition = UnifiedLLMStepFunctionsGenerator.generate_unified_llm_agent_definition(
            agent_name=self.agent_name,
            unified_llm_arn=self.unified_llm_arn,
            tool_configs=self.tool_configs,
            system_prompt=self.system_prompt,
            structured_output_schema=self.structured_output_schema,
            default_provider="anthropic",
            default_model="claude-3-5-sonnet-20241022",
            llm_models_table_name=self.llm_models_table_name,
            agent_registry_table_name=self.agent_registry_table_name,
            tool_registry_table_name=self.tool_registry_table_name,
            extraction_name=self.extraction_name
        )

        # Create IAM role for the state machine
        state_machine_role = iam.Role(
            self, "StateMachineRole",
            assumed_by=iam.ServicePrincipal("states.amazonaws.com"),
            description=f"Role for {self.agent_name} state machine"
        )

        # Grant permissions to invoke Lambda functions
        state_machine_role.add_to_policy(
            iam.PolicyStatement(
                actions=["lambda:InvokeFunction"],
                resources=[
                    self.unified_llm_arn,
                    self.browser_remote_lambda_arn
                ]
            )
        )

        # Grant DynamoDB permissions
        state_machine_role.add_to_policy(
            iam.PolicyStatement(
                actions=["dynamodb:GetItem"],
                resources=[
                    f"arn:aws:dynamodb:{self.region}:{self.account}:table/{self.agent_registry_table_name}",
                    f"arn:aws:dynamodb:{self.region}:{self.account}:table/{self.tool_registry_table_name}",
                    f"arn:aws:dynamodb:{self.region}:{self.account}:table/{self.llm_models_table_name}"
                ]
            )
        )

        # Grant CloudWatch metrics permissions
        state_machine_role.add_to_policy(
            iam.PolicyStatement(
                actions=["cloudwatch:PutMetricData"],
                resources=["*"]
            )
        )

        # Grant permissions for remote execution activity
        state_machine_role.add_to_policy(
            iam.PolicyStatement(
                actions=[
                    "states:SendTaskSuccess",
                    "states:SendTaskFailure",
                    "states:SendTaskHeartbeat"
                ],
                resources=[self.browser_remote_activity_arn]
            )
        )

        # Create the state machine
        self.state_machine = sfn.CfnStateMachine(
            self, "broadband-availability-bt-wholesale-structuredStateMachine",
            state_machine_name=f"{self.agent_name}-{self.env_name}",
            definition_string=state_machine_definition,
            role_arn=state_machine_role.role_arn,
            tracing_configuration={
                "enabled": True
            }
        )

        # Tag the resources
        Tags.of(self).add("Agent", self.agent_name)
        Tags.of(self).add("Environment", self.env_name)
        Tags.of(self).add("Type", "structured-output")
        Tags.of(self).add("Generator", "schema-factory")
        Tags.of(self).add("SchemaVersion", "1.0.0")

        # Register agent in registry with structured output configuration
        agent_spec = {
            "agent_name": self.agent_name,
            "version": "v1.0",
            "status": "active",
            "system_prompt": self.system_prompt,
            "description": "Check broadband availability for UK addresses using BT Wholesale Broadband Checker portal",
            "llm_provider": "anthropic",
            "llm_model": "claude-3-5-sonnet-20241022",
            "tools": json.dumps([
                {"tool_name": "browser_remote", "enabled": True}
            ]),
            "structured_output": json.dumps({
                "enabled": True,
                "schemas": {
                    "broadband_availability_bt_wholesale_data": {
                        "schema": self.structured_output_schema,
                        "canonical_schema_version": "1.0.0",
                        "canonical_schema_id": "broadband_availability_bt_wholesale"
                    }
                },
                "output_fields": ["availability", "cabinet", "downstream_mbps", "exchange", "metadata", "screenshot_url", "service_type", "success", "upstream_mbps"]
            }),
            "state_machine_arn": self.state_machine.attr_arn,
            "environment": self.env_name,
            "metadata": {
                "supports_batch_processing": True,
                "structured_output_enabled": True,
                "execution_type": "remote_activity",
                "schema_driven": True,
                "canonical_schema": "broadband_availability_bt_wholesale v1.0.0",
                "profile_name": "Bt_broadband"
            }
        }

        BaseAgentConstruct(
            self,
            f"{self.agent_name.replace('-', '')}Registration",
            agent_spec=agent_spec,
            env_name=self.env_name
        )

        # Outputs
        CfnOutput(
            self, "StateMachineArn",
            value=self.state_machine.attr_arn,
            export_name=f"{self.agent_name}-state-machine-arn-{self.env_name}",
            description=f"ARN of the {self.agent_name} state machine"
        )

        CfnOutput(
            self, "StateMachineName",
            value=self.state_machine.state_machine_name,
            export_name=f"{self.agent_name}-state-machine-name-{self.env_name}",
            description=f"Name of the {self.agent_name} state machine"
        )

        CfnOutput(
            self, "CanonicalSchemaVersion",
            value="1.0.0",
            description="Version of the canonical schema used to generate this agent"
        )
